"""
Phase 2: åˆ†æãƒ¬ãƒãƒ¼ãƒˆæ§‹é€ åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
Phase 1ã§åé›†ã•ã‚ŒãŸJSONãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã€
æ§‹é€ åŒ–ã•ã‚ŒãŸMarkdownå½¢å¼ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã€‚ï¼ˆã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆè¦–ç‚¹ï¼‰
"""
import os
import sys
import json
import traceback
from datetime import datetime

from langchain_core.messages import HumanMessage
from langchain_google_genai import ChatGoogleGenerativeAI

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
from config_loader import get_config

def generate_analysis_report(target_year: int = None):
    """åé›†ã—ãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹"""
    print("\n" + "=" * 60)
    print("ğŸ§  Phase 2: åˆ†æãƒ¬ãƒãƒ¼ãƒˆæ§‹é€ åŒ–ã‚’é–‹å§‹")
    print("=" * 60)

    # --- 0. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ ---
    config = get_config()

    # --- 1. ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª ---
    google_api_key = os.environ.get("GOOGLE_API_KEY")
    if not google_api_key:
        print("âŒ ã‚¨ãƒ©ãƒ¼: GOOGLE_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
        sys.exit(1)

    # --- 2. JSONãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ ---
    research_data_path = config.get("data.research_data_path", "reports/research_data.json")
    if not os.path.exists(research_data_path):
        print(f"âŒ ã‚¨ãƒ©ãƒ¼: æ¤œç´¢ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {research_data_path}")
        print("Phase 1 (research_searcher.py)ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
        sys.exit(1)

    with open(research_data_path, "r", encoding="utf-8") as f:
        raw_data = json.load(f)

    if not raw_data:
        print("âš ï¸ è­¦å‘Š: JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã€‚")
        sys.exit(0)

    # JSONãƒ‡ãƒ¼ã‚¿ã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«çµ„ã¿è¾¼ã‚€ãŸã‚ã«æ–‡å­—åˆ—åŒ–
    data_string = json.dumps(raw_data, indent=2, ensure_ascii=False)

    print(f"âœ“ {len(raw_data)}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸã€‚")

    # --- 3. LLMã®æº–å‚™ ---
    model = ChatGoogleGenerativeAI(
        model=config.get("llm.analyzer.model", "gemini-2.5-flash"),
        temperature=config.get("llm.analyzer.temperature", 0.1),
    )
    print("âœ“ LLMã‚’è¨­å®šã—ã¾ã—ãŸ")

    # --- 4. ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å®šç¾© (ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆè¦–ç‚¹ã§ãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—æ¸ˆã¿) ---
    analysis_prompt = f"""
ã‚ãªãŸã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¼æ¥­ã®äººäº‹æˆ¦ç•¥ã‚’æ‹…å½“ã™ã‚‹**ä¸»å¸­ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ**ã§ã™ã€‚
æä¾›ã•ã‚ŒãŸ**JSONå½¢å¼ã®èª¿æŸ»ãƒ‡ãƒ¼ã‚¿**ï¼ˆä¸€æ¬¡æƒ…å ±æŠ½å‡ºçµæœï¼‰ã«åŸºã¥ãã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆè£½é€ æ¥­ä¼æ¥­ã®çµŒå–¶å±¤ãƒ»äººäº‹éƒ¨é–€ï¼‰ãŒ**ç›´ã¡ã«æˆ¦ç•¥æ„æ€æ±ºå®šã«ä½¿ãˆã‚‹**ã€æ§‹é€ çš„ã‹ã¤æ´å¯Ÿã«æº€ã¡ãŸé€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’Markdownå½¢å¼ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚

å˜ãªã‚‹ãƒ‡ãƒ¼ã‚¿è¦ç´„ã§ã¯ãªãã€**ãƒ“ã‚¸ãƒã‚¹ä¸Šã®æ„å‘³åˆã„**ã¨**ç«¶äº‰å„ªä½æ€§**ã«ç„¦ç‚¹ã‚’å½“ã¦ãŸåˆ†æã‚’è¡Œã†ã“ã¨ãŒã‚ãªãŸã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã§ã™ã€‚

# ğŸ“„ å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ (JSON)
---
{data_string}
---

# ğŸ“‹ ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¨åˆ†ææ·±åº¦
ä¸Šè¨˜ã®JSONãƒ‡ãƒ¼ã‚¿ã«å«ã¾ã‚Œã‚‹æƒ…å ±ã‚’å¾¹åº•çš„ã«åˆ†æã—ã€ä»¥ä¸‹ã®æ§‹æˆã§ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

## ğŸ“Š ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼ (Executive Summary)
**æœ€ã‚‚é‡è¦ã‹ã¤ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã®ã‚ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚** çµŒå–¶å±¤ãŒ5åˆ†ã§å…¨ä½“åƒã‚’æ´ã‚ã‚‹ã‚ˆã†ã€**å…·ä½“çš„ãªè¡Œå‹•ï¼ˆActionable Insightsï¼‰**ã«ç¹‹ãŒã‚‹æ´å¯Ÿã‚’å«ã‚ã¦ãã ã•ã„ã€‚

### ğŸ¯ ä»Šé€±ã®æœ€é‡è¦ãƒã‚¤ãƒ©ã‚¤ãƒˆ (Top 3 Insights)
åé›†ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¾—ã‚‰ã‚Œã‚‹æœ€ã‚‚æˆ¦ç•¥çš„ã«é‡è¦ãª**3ã¤ã®æ´å¯Ÿ**ã‚’ã€ä»¥ä¸‹ã®å½¢å¼ã§æç¤ºã—ã¦ãã ã•ã„ï¼š

1.  **[æ´å¯Ÿ1ã®ã‚¿ã‚¤ãƒˆãƒ«]**: [200-300æ–‡å­—ã§è©³ç´°ã‚’èª¬æ˜ã€‚å˜ãªã‚‹ãƒ‹ãƒ¥ãƒ¼ã‚¹ã§ã¯ãªãã€ãã‚ŒãŒç¤ºå”†ã™ã‚‹ãƒˆãƒ¬ãƒ³ãƒ‰ã‚„å½±éŸ¿ã‚’å«ã‚ã‚‹]

2.  **[æ´å¯Ÿ2ã®ã‚¿ã‚¤ãƒˆãƒ«]**: [åŒæ§˜ã«]

3.  **[æ´å¯Ÿ3ã®ã‚¿ã‚¤ãƒˆãƒ«]**: [åŒæ§˜ã«]

### âš¡ æ³¨ç›®ãƒˆãƒ¬ãƒ³ãƒ‰ã¨ãã®ãƒªã‚¹ã‚¯/æ©Ÿä¼š
ä¸»è¦ãªãƒˆãƒ¬ãƒ³ãƒ‰ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§åˆ†æã—ã¦ãã ã•ã„ï¼š

**ãƒˆãƒ¬ãƒ³ãƒ‰**: [ãƒˆãƒ¬ãƒ³ãƒ‰å]
-   **æ©Ÿä¼š (Opportunity)**:
    -   **çŸ­æœŸï¼ˆ6ãƒ¶æœˆä»¥å†…ï¼‰**: [å…·ä½“çš„ãªæ©Ÿä¼šã‚’2-3æ–‡ã§]
    -   **ä¸­æœŸï¼ˆ1-2å¹´ï¼‰**: [å…·ä½“çš„ãªæ©Ÿä¼šã‚’2-3æ–‡ã§]
-   **ãƒªã‚¹ã‚¯ (Risk)**:
    -   **çŸ­æœŸï¼ˆ6ãƒ¶æœˆä»¥å†…ï¼‰**: [å…·ä½“çš„ãªãƒªã‚¹ã‚¯ã‚’2-3æ–‡ã§]
    -   **ä¸­æœŸï¼ˆ1-2å¹´ï¼‰**: [å…·ä½“çš„ãªãƒªã‚¹ã‚¯ã‚’2-3æ–‡ã§]

### âœ… æ¨å¥¨ã•ã‚Œã‚‹å³æ™‚ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
ä»Šé€±ã®å‹•å‘ã«åŸºã¥ãã€äººäº‹éƒ¨é–€ãŒ**ç›´ã¡ã«è©•ä¾¡ã¾ãŸã¯é–‹å§‹ã™ã¹ãå…·ä½“çš„ãªæ¤œè¨äº‹é …**ã‚’ä»¥ä¸‹ã®å½¢å¼ã§1ï½2ç‚¹ææ¡ˆã—ã¦ãã ã•ã„ï¼š

1.  **[ã‚¢ã‚¯ã‚·ãƒ§ãƒ³1ã®ã‚¿ã‚¤ãƒˆãƒ«]**: [å…·ä½“çš„ãªå†…å®¹ã‚’3-4æ–‡ã§èª¬æ˜ã€‚å¯¾è±¡ç¯„å›²ã€æœŸé–“ã€æœŸå¾…åŠ¹æœã‚’å«ã‚ã‚‹]

2.  **[ã‚¢ã‚¯ã‚·ãƒ§ãƒ³2ã®ã‚¿ã‚¤ãƒˆãƒ«]**: [åŒæ§˜ã«]

## èª¿æŸ»çµæœè©³ç´° (Detailed Findings)
å…¥åŠ›JSONãƒ‡ãƒ¼ã‚¿ã«å«ã¾ã‚Œã‚‹å„è¨˜äº‹ã«ã¤ã„ã¦ã€**è©³ç´°ã‹ã¤æˆ¦ç•¥çš„ãªåˆ†æãƒ¬ãƒãƒ¼ãƒˆ**ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
ãŸã ã—ã€ä¿¡é ¼æ€§ã‚¹ã‚³ã‚¢ãŒ0.5æœªæº€ã®è¨˜äº‹ã¯è¨˜è¼‰ã—ãªã„ã§ãã ã•ã„ã€‚

**é‡è¦**: å„äº‹ä¾‹ã¯**1,000ï½1,500æ–‡å­—ç¨‹åº¦**ã®è©³ç´°ãªåˆ†æã¨ã—ã€ç¤¾å†…ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã¨ã—ã¦ååˆ†ãªæƒ…å ±é‡ã‚’ç¢ºä¿ã—ã¦ãã ã•ã„ã€‚

### [é€£ç•ª]. [è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«]

#### ğŸ“‹ åŸºæœ¬æƒ…å ±
-   **URL**: [è¨˜äº‹URL]
-   **æƒ…å ±æº**: [ãƒ¡ãƒ‡ã‚£ã‚¢å]ï¼ˆ[çµ„ç¹”ã®ç‰¹å¾´ãƒ»ä¿¡é ¼æ€§ã®ç†ç”±ã‚’1æ–‡ã§]ï¼‰
-   **å…¬é–‹æ—¥**: YYYY-MM-DD
-   **åœ°åŸŸ**: [å›½å]
-   **ã‚«ãƒ†ã‚´ãƒª**: [ã‚«ãƒ†ã‚´ãƒªå]
-   **é–¢é€£ä¼æ¥­**: [ä¼æ¥­å1], [ä¼æ¥­å2]...
-   **è£½é€ æ¥­é–¢é€£**: âœ“ ã‚ã‚Š / - ãªã—
-   **ä¿¡é ¼æ€§ã‚¹ã‚³ã‚¢**: 0.0ï½1.0

#### ğŸŒ èƒŒæ™¯ã¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆ200-300æ–‡å­—ï¼‰
**æ¥­ç•Œå‹•å‘**:
[ã“ã®è¨˜äº‹ãŒç™ºè¡¨ã•ã‚ŒãŸèƒŒæ™¯ã«ã‚ã‚‹ã€æ¥­ç•Œå…¨ä½“ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã‚„å¸‚å ´ç’°å¢ƒã‚’èª¬æ˜ã€‚å¯èƒ½ã§ã‚ã‚Œã°çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚„ä»–ã®æƒ…å ±æºã¸ã®è¨€åŠã‚’å«ã‚ã‚‹]

**è¨˜äº‹ã®ä½ç½®ã¥ã‘**:
[ã“ã®æƒ…å ±æºï¼ˆãƒ¡ãƒ‡ã‚£ã‚¢ãƒ»ä¼æ¥­ï¼‰ãŒãªãœã“ã®ãƒ†ãƒ¼ãƒã‚’å–ã‚Šä¸Šã’ãŸã®ã‹ã€ãã®æˆ¦ç•¥çš„æ„å›³ã‚„å°‚é–€æ€§ã«ã¤ã„ã¦]

#### ğŸ“Š ä¸»è¦ãªè«–ç‚¹ã¨è©³ç´°åˆ†æï¼ˆ400-600æ–‡å­—ï¼‰

**1. [ç¬¬ä¸€ã®ä¸»è¦ãƒ†ãƒ¼ãƒ]**
-   **è©³ç´°**: [å…·ä½“çš„ãªå†…å®¹ã‚’3-5æ–‡ã§è©³è¿°ã€‚å˜ãªã‚‹è¦ç´„ã§ã¯ãªãã€æŠ€è¡“çš„å´é¢ã‚„æˆ¦ç•¥çš„æ„ç¾©ã‚’æ·±æ˜ã‚Š]
-   **å…·ä½“ä¾‹**:
    - [å¯èƒ½ã§ã‚ã‚Œã°ã€è¨˜äº‹å†…ã§è¨€åŠã•ã‚Œã¦ã„ã‚‹ä¼æ¥­äº‹ä¾‹ã‚„æ•°å€¤ãƒ‡ãƒ¼ã‚¿ã‚’ç®‡æ¡æ›¸ãã§]
    - [è¤‡æ•°ã®äº‹ä¾‹ãŒã‚ã‚‹å ´åˆã¯2-3å€‹åˆ—æŒ™]
-   **çµ±è¨ˆãƒ»ãƒ‡ãƒ¼ã‚¿**: [è¨˜äº‹å†…ã®æ•°å€¤ã‚„èª¿æŸ»çµæœãŒã‚ã‚Œã°å¼•ç”¨]

**2. [ç¬¬äºŒã®ä¸»è¦ãƒ†ãƒ¼ãƒ]**ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
-   **è©³ç´°**: [åŒæ§˜ã«è©³è¿°]
-   **æ¥­ç•Œã¸ã®å½±éŸ¿**: [ã“ã®ãƒ†ãƒ¼ãƒãŒäººäº‹ãƒ»è£½é€ æ¥­ç•Œå…¨ä½“ã«ã©ã†å½±éŸ¿ã™ã‚‹ã‹]

#### ğŸ­ è£½é€ æ¥­ã¸ã®ç¤ºå”†ã¨é©ç”¨ã‚·ãƒŠãƒªã‚ªï¼ˆ300-400æ–‡å­—ï¼‰

**çŸ­æœŸçš„ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆï¼ˆ6ãƒ¶æœˆä»¥å†…ï¼‰**:
-   âœ… **æ©Ÿä¼š**: [ã“ã®å‹•å‘ã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§å¾—ã‚‰ã‚Œã‚‹å…·ä½“çš„ãªãƒ¡ãƒªãƒƒãƒˆã€‚å¯èƒ½ã§ã‚ã‚Œã°å®šé‡çš„åŠ¹æœã‚„ä»–ç¤¾äº‹ä¾‹ã‚’å«ã‚ã‚‹]
-   âš ï¸ **ãƒªã‚¹ã‚¯**: [å¯¾å¿œã—ãªã„å ´åˆã®å…·ä½“çš„ãªãƒªã‚¹ã‚¯ã€‚ç«¶åˆå„ªä½æ€§ã®å–ªå¤±ã€äººææµå‡ºç­‰]

**ä¸­æœŸçš„ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆï¼ˆ1-2å¹´ï¼‰**:
-   âœ… **æ©Ÿä¼š**: [æˆ¦ç•¥çš„ãªæ´»ç”¨ã«ã‚ˆã‚‹ä¸­é•·æœŸçš„ãªãƒ¡ãƒªãƒƒãƒˆ]
-   âš ï¸ **ãƒªã‚¹ã‚¯**: [å¸‚å ´ç’°å¢ƒã®å¤‰åŒ–ã«ä¼´ã†ä¸­é•·æœŸçš„ãªãƒªã‚¹ã‚¯]

#### ğŸ¯ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ200-300æ–‡å­—ï¼‰

**å³æ™‚ç€æ‰‹ï¼ˆPriority 1ï¼‰**:
1.  **[å…·ä½“çš„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³1]**
    -   å¯¾è±¡: [éƒ¨é–€ãƒ»å¯¾è±¡ç¯„å›²]
    -   æœŸé–“: [ç›®å®‰æœŸé–“]
    -   äºˆç®—ç›®å®‰: [æ¦‚ç®—ãŒã‚ã‚Œã°]
    -   æœŸå¾…åŠ¹æœ: [å®šæ€§çš„ã¾ãŸã¯å®šé‡çš„ãªåŠ¹æœ]

2.  **[å…·ä½“çš„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³2]**ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
    -   [åŒæ§˜ã«è¨˜è¼‰]

**æˆ¦ç•¥çš„æ¤œè¨ï¼ˆPriority 2ï¼‰**:
-   [ä¸­é•·æœŸçš„ãªæ¤œè¨äº‹é …ã‚„ã€äººäº‹åˆ¶åº¦ãƒ»çµŒå–¶æˆ¦ç•¥ã¸ã®çµ„ã¿è¾¼ã¿ææ¡ˆ]

#### ğŸ“š é–¢é€£æŠ€è¡“ãƒ»ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
-   **[æŠ€è¡“ã‚«ãƒ†ã‚´ãƒª1]**: [å…·ä½“çš„ãªæŠ€è¡“åãƒ»æ¨™æº–å]
-   **[æŠ€è¡“ã‚«ãƒ†ã‚´ãƒª2]**: [åŒæ§˜ã«]
-   **[ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯/æ‰‹æ³•]**: [è©²å½“ã™ã‚‹å ´åˆ]

#### ğŸ”— è£œè¶³æƒ…å ±
-   **é–¢é€£æŠ€è¡“ã‚¿ã‚°**: `tag1` `tag2` `tag3` `tag4` `tag5`
-   **ã•ã‚‰ãªã‚‹æƒ…å ±æº**: [é–¢é€£ã™ã‚‹ä»–ã®è¨˜äº‹ã‚„ãƒ™ãƒ³ãƒ€ãƒ¼æƒ…å ±ãŒã‚ã‚Œã°ç°¡æ½”ã«è¨€åŠ]

---

## ğŸ“ˆ æˆ¦ç•¥çš„ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ (Strategic Trend Analysis)
ãƒ‡ãƒ¼ã‚¿å…¨ä½“ã‚’çµ±åˆã—ã€ã‚ˆã‚Šé«˜åº¦ãªåˆ†æã‚’æä¾›ã—ã¾ã™ã€‚å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯**300-500æ–‡å­—ç¨‹åº¦**ã§è©³è¿°ã—ã¦ãã ã•ã„ã€‚

### 1. ğŸ”„ ä¸»è¦ãªãƒ†ãƒ¼ãƒã¨é€²åŒ–ã®æ–¹å‘æ€§
å‡ºç¾é »åº¦ã®é«˜ã„ãƒ†ãƒ¼ãƒï¼ˆä¾‹: ã‚¹ã‚­ãƒ«ã‚®ãƒ£ãƒƒãƒ—ã®AIé§†å‹•å‹ç‰¹å®šï¼‰ã«ã¤ã„ã¦åˆ†æã—ã¦ãã ã•ã„ï¼š

-   **ç¾åœ¨ã®ãƒˆãƒ¬ãƒ³ãƒ‰**: [3-4æ–‡ã§ç¾çŠ¶ã‚’èª¬æ˜]
-   **6ãƒ¶æœˆå¾Œã®äºˆæ¸¬**: [ã“ã®æŠ€è¡“ã‚„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒã©ã†é€²åŒ–ã™ã‚‹ã‹]
-   **1å¹´å¾Œã®äºˆæ¸¬**: [ä¸­é•·æœŸçš„ãªé€²åŒ–ã®æ–¹å‘æ€§]
-   **è£½é€ æ¥­ã¸ã®å½±éŸ¿**: [ã“ã®ãƒˆãƒ¬ãƒ³ãƒ‰ãŒè£½é€ æ¥­ã«ã‚‚ãŸã‚‰ã™å…·ä½“çš„ãªå¤‰åŒ–]

ï¼ˆä¸»è¦ãƒ†ãƒ¼ãƒãŒè¤‡æ•°ã‚ã‚‹å ´åˆã¯ã€åŒæ§˜ã®å½¢å¼ã§2-3å€‹è¨˜è¼‰ï¼‰

### 2. ğŸ—ºï¸ å¸‚å ´ã®ç„¦ç‚¹ã¨ç«¶äº‰åœ°å›³ (Competitive Landscape)
æ³¨ç›®ä¼æ¥­ã‚„è³‡é‡‘èª¿é”ã®å‹•ãã‹ã‚‰ã€å¸‚å ´åˆ†æã‚’è¡Œã£ã¦ãã ã•ã„ï¼š

-   **æŠ•è³‡ãŒé›†ä¸­ã—ã¦ã„ã‚‹é ˜åŸŸ**: [ä¾‹: ã‚¹ã‚­ãƒ«ã‚ªãƒ³ãƒˆãƒ­ã‚¸ãƒ¼ã€LXPç­‰ã€‚å„é ˜åŸŸã‚’2-3æ–‡ã§èª¬æ˜]
-   **ä¸»è¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ†æ**:
    -   **[ä¼æ¥­ã‚«ãƒ†ã‚´ãƒª1ï¼ˆä¾‹ï¼šå¤§æ‰‹HRãƒ†ãƒƒã‚¯ï¼‰]**: [ä¼æ¥­åã¨æˆ¦ç•¥ã‚’2-3æ–‡ã§]
    -   **[ä¼æ¥­ã‚«ãƒ†ã‚´ãƒª2ï¼ˆä¾‹ï¼šæ–°èˆˆã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ï¼‰]**: [åŒæ§˜ã«]
-   **å¸‚å ´äºˆæ¸¬**: [ä»Šå¾Œ1-2å¹´ã®å¸‚å ´å‹•å‘äºˆæ¸¬]

### 3. ğŸ¯ ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã®æˆç†Ÿåº¦è©•ä¾¡
ä¸»è¦ãªæŠ€è¡“ã«ã¤ã„ã¦ã€æˆç†Ÿåº¦ã‚’è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã®å½¢å¼ã§2-4ã¤ã®æŠ€è¡“ã‚’åˆ†æï¼š

**[æŠ€è¡“å1]**: ğŸ”´ é»æ˜æœŸ / ğŸŸ¡ æˆé•·æœŸ / ğŸŸ¢ æˆç†ŸæœŸ
-   **è©•ä¾¡ç†ç”±**: [3-4æ–‡ã§ã€ãªãœã“ã®æˆç†Ÿåº¦ã¨åˆ¤æ–­ã—ãŸã‹ã€‚å¸‚å ´å°å…¥äº‹ä¾‹ã€æ¨™æº–åŒ–çŠ¶æ³ã€èª²é¡Œç­‰ã‚’å«ã‚ã‚‹]
-   **è£½é€ æ¥­ã¸ã®å°å…¥æ¨å¥¨åº¦**: â­â­â­â­â­ï¼ˆ5æ®µéšè©•ä¾¡ã¨ç†ç”±ã‚’1-2æ–‡ã§ï¼‰

**[æŠ€è¡“å2]**: [åŒæ§˜ã«]

## ğŸ­ è£½é€ æ¥­å‘ã‘è¡Œå‹•æè¨€ (Recommended Actions for Manufacturing)
ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã®çµè«–ã¨ãªã‚‹æœ€ã‚‚é‡è¦ãªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚å…·ä½“çš„ã‹ã¤å®Ÿè¡Œå¯èƒ½ãªæè¨€ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

### ğŸ¯ ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã™ã¹ãå„ªå…ˆèª²é¡Œ
è£½é€ æ¥­ç‰¹æœ‰ã®èª²é¡Œã«å¯¾ã—ã€åé›†ã—ãŸãƒˆãƒ¬ãƒ³ãƒ‰ãŒã©ã®ã‚ˆã†ã«å½¹ç«‹ã¤ã‹ã€**å„ªå…ˆé †ä½ä»˜ã‘**ã—ã¦æè¨€ã—ã¦ãã ã•ã„ï¼ˆå„èª²é¡Œ200-300æ–‡å­—ï¼‰ï¼š

**å„ªå…ˆåº¦ğŸ”´ High:**
1.  **[èª²é¡Œ1]**:
    -   **ç¾çŠ¶èªè­˜**: [èª²é¡Œã®èƒŒæ™¯ã‚’2-3æ–‡ã§]
    -   **ãƒˆãƒ¬ãƒ³ãƒ‰ã®æ´»ç”¨æ–¹æ³•**: [ä»Šé€±ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¾—ã‚‰ã‚ŒãŸè§£æ±ºç­–]
    -   **æœŸå¾…åŠ¹æœ**: [å®šæ€§çš„ãƒ»å®šé‡çš„ãªåŠ¹æœ]

**å„ªå…ˆåº¦ğŸŸ¡ Medium:**
2.  **[èª²é¡Œ2]**: [åŒæ§˜ã«]

### ğŸ“‹ æ¬¡æœŸæ¤œè¨ã‚¹ãƒ†ãƒƒãƒ—
ãƒ¬ãƒãƒ¼ãƒˆå…¨ä½“ã‚’é€šã—ã¦æœ€ã‚‚æˆ¦ç•¥çš„ã¨åˆ¤æ–­ã—ãŸ**å…·ä½“çš„ãª3ã¤ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ **ã‚’ææ¡ˆã—ã¦ãã ã•ã„ï¼ˆå„300-400æ–‡å­—ï¼‰ï¼š

1.  **[ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ 1ã®ã‚¿ã‚¤ãƒˆãƒ«]**:
    -   **å†…å®¹**: [å…·ä½“çš„ãªå®Ÿæ–½å†…å®¹ã‚’3-4æ–‡ã§]
    -   **ç›®çš„**: [ã“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®æˆ¦ç•¥çš„ç›®çš„]
    -   **å®Ÿæ–½ä½“åˆ¶**: [æ¨å¥¨ã•ã‚Œã‚‹æ‹…å½“éƒ¨é–€ã‚„å¤–éƒ¨ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼]
    -   **æœŸé–“ãƒ»äºˆç®—**: [ç›®å®‰ã¨ãªã‚‹æœŸé–“ã¨äºˆç®—è¦æ¨¡]
    -   **æˆåŠŸæŒ‡æ¨™ï¼ˆKPIï¼‰**: [æ¸¬å®šå¯èƒ½ãªæˆæœæŒ‡æ¨™]

2.  **[ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ 2]**: [åŒæ§˜ã«]

3.  **[ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ 3]**: [åŒæ§˜ã«]

## ğŸ“š å‚è€ƒæƒ…å ±æºä¸€è¦§ (Source Index)
èª¿æŸ»ã«ä½¿ç”¨ã—ãŸå…¨URLã‚’ä»¥ä¸‹ã®å½¢å¼ã§ä¸€è¦§åŒ–ã—ã¦ãã ã•ã„ï¼š

### ä¿¡é ¼æ€§ã‚¹ã‚³ã‚¢åˆ¥åˆ†é¡

**â­â­â­â­â­ é«˜ä¿¡é ¼æ€§ã‚½ãƒ¼ã‚¹ï¼ˆ0.8ä»¥ä¸Šï¼‰**
-   [è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«](URL) - [æƒ…å ±æºå] - [å…¬é–‹æ—¥]

**â­â­â­ ä¸­ä¿¡é ¼æ€§ã‚½ãƒ¼ã‚¹ï¼ˆ0.6-0.7ï¼‰**
-   [è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«](URL) - [æƒ…å ±æºå] - [å…¬é–‹æ—¥]

**ğŸ“Œ å…¨ã‚½ãƒ¼ã‚¹ä¸€è¦§ï¼ˆURLé †ï¼‰**
-   URL1
-   URL2
-   ...

---

**ğŸ” é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰**: [ä»Šé€±ã®ãƒ¬ãƒãƒ¼ãƒˆã§é »å‡ºã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚¿ã‚°å½¢å¼ã§åˆ—æŒ™]

**ğŸ“Š æ¬¡å›èª¿æŸ»ã®æ¨å¥¨ãƒ†ãƒ¼ãƒ**: [ä»Šé€±ã®èª¿æŸ»ã‹ã‚‰æ´¾ç”Ÿã™ã‚‹ã€æ¬¡å›æ·±æ˜ã‚Šã™ã¹ããƒ†ãƒ¼ãƒã‚’1-2å€‹ææ¡ˆ]
"""

    # --- 5. LLMã®å®Ÿè¡Œ ---
    today = datetime.now()
    year = target_year or today.year
    final_report = None
    
    try:
        response = model.invoke([HumanMessage(content=analysis_prompt)])
        final_report = response.content or "ï¼ˆå†…å®¹ãªã—ï¼‰"

    except Exception as e:
        print(f"\nâŒ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
        traceback.print_exc()
        sys.exit(1)

    # --- 6. ãƒ¬ãƒãƒ¼ãƒˆã®ä¿å­˜ ---
    reports_dir = config.get("data.reports_dir", "reports")
    os.makedirs(reports_dir, exist_ok=True)
    date_str = today.strftime("%Y%m%d")

    # ãƒ•ã‚¡ã‚¤ãƒ«åãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ç”Ÿæˆ
    filename_template = config.get("report.filename_template", "é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ_{year}_{date}.md")
    file_name = os.path.join(reports_dir, filename_template.format(year=year, date=date_str))

    # ãƒ¬ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒˆãƒ«
    title_template = config.get("report.title_template", "é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ: ã‚¹ã‚­ãƒ«ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆãƒ»ã‚¿ãƒ¬ãƒ³ãƒˆãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆå‹•å‘ ({year}å¹´ç‰ˆ)")
    report_title = title_template.format(year=year)
    author = config.get("report.author", "ä¸»å¸­ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆã«ã‚ˆã‚‹åˆ†æ")

    try:
        with open(file_name, "w", encoding="utf-8") as f:
            # ãƒãƒƒã‚¸ã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚€ãƒªãƒƒãƒãªãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½œæˆ
            header = (
                f"# ğŸ“Š {report_title}\n\n"
                f"![èª¿æŸ»ä»¶æ•°](https://img.shields.io/badge/èª¿æŸ»ä»¶æ•°-{len(raw_data)}ä»¶-blue) "
                f"![ç”Ÿæˆæ—¥](https://img.shields.io/badge/ç”Ÿæˆæ—¥-{today.strftime('%Y.%m.%d')}-green) "
                f"![åˆ†æè€…](https://img.shields.io/badge/åˆ†æè€…-{author.replace(' ', '_')}-orange)\n\n"
                f"**ğŸ“… ç”Ÿæˆæ—¥æ™‚**: {today.strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')}  \n"
                f"**ğŸ“ˆ èª¿æŸ»å¯¾è±¡**: æµ·å¤–HRãƒ»ã‚¿ãƒ¬ãƒ³ãƒˆãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆãƒˆãƒ¬ãƒ³ãƒ‰  \n"
                f"**ğŸ¯ å¯¾è±¡èª­è€…**: è£½é€ æ¥­ çµŒå–¶å±¤ãƒ»äººäº‹éƒ¨é–€\n\n"
                f"---\n\n"
                f"## ğŸ“‘ ç›®æ¬¡ (Table of Contents)\n\n"
                f"1. [ğŸ“Š ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼](#-ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼-executive-summary)\n"
                f"2. [ğŸ“‹ èª¿æŸ»çµæœè©³ç´°](#-èª¿æŸ»çµæœè©³ç´°-detailed-findings)\n"
                f"3. [ğŸ“ˆ æˆ¦ç•¥çš„ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ](#-æˆ¦ç•¥çš„ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ-strategic-trend-analysis)\n"
                f"4. [ğŸ­ è£½é€ æ¥­å‘ã‘è¡Œå‹•æè¨€](#-è£½é€ æ¥­å‘ã‘è¡Œå‹•æè¨€-recommended-actions-for-manufacturing)\n"
                f"5. [ğŸ“š å‚è€ƒæƒ…å ±æºä¸€è¦§](#-å‚è€ƒæƒ…å ±æºä¸€è¦§-source-index)\n\n"
                f"---\n\n"
            )
            f.write(header + final_report)

        print("\n" + "=" * 60)
        print("âœ“ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº† (ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆè¦–ç‚¹)")
        print("=" * 60)
        print(f"ğŸ“„ ä¿å­˜å…ˆ: {file_name}")
        print("=" * 60 + "\n")
        
    except Exception as e:
        print(f"\nâŒ Markdownãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
        traceback.print_exc()
        sys.exit(1)


if __name__ == "__main__":
    year_arg = None
    if len(sys.argv) > 1:
        try:
            year_arg = int(sys.argv[1])
        except ValueError:
            print("âš ï¸ å¹´æŒ‡å®šãŒä¸æ­£ã§ã™ã€‚æ•´æ•°ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚ä¾‹: python research_analyzer.py 2026")

    generate_analysis_report(target_year=year_arg)
