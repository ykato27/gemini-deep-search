"""
Phase 2: 分析レポート構造化スクリプト
Phase 1で収集されたJSONデータに基づき、
構造化されたMarkdown形式のレポートを生成する。（コンサルタント視点）
"""
import os
import sys
import json
import traceback
from datetime import datetime

from langchain_core.messages import HumanMessage
from langchain_google_genai import ChatGoogleGenerativeAI

# JSONファイルパス (検索フェーズと共有)
RESEARCH_DATA_PATH = "reports/research_data.json"

def generate_analysis_report(target_year: int = None):
    """収集したデータから週次レポートを生成する"""
    print("\n" + "=" * 60)
    print("🧠 Phase 2: 分析レポート構造化を開始")
    print("=" * 60)

    # --- 1. 環境変数の確認 ---
    google_api_key = os.environ.get("GOOGLE_API_KEY")
    if not google_api_key:
        print("❌ エラー: GOOGLE_API_KEYが設定されていません")
        sys.exit(1)
    
    # --- 2. JSONデータの読み込み ---
    if not os.path.exists(RESEARCH_DATA_PATH):
        print(f"❌ エラー: 検索データファイルが見つかりません: {RESEARCH_DATA_PATH}")
        print("Phase 1 (research_searcher.py)が正常に実行され、ファイルが作成されているか確認してください。")
        sys.exit(1)

    with open(RESEARCH_DATA_PATH, "r", encoding="utf-8") as f:
        raw_data = json.load(f)

    if not raw_data:
        print("⚠️ 警告: JSONファイルにはデータが含まれていませんでした。レポートを生成できません。")
        sys.exit(0)

    # JSONデータをプロンプトに組み込むために文字列化
    data_string = json.dumps(raw_data, indent=2, ensure_ascii=False)
    
    print(f"✓ {len(raw_data)}件のデータが読み込まれました。")

    # --- 3. LLMの準備 ---
    model = ChatGoogleGenerativeAI(
        model="gemini-2.5-flash",
        temperature=0.1, # 分析には少し創造性を許容
    )
    print("✓ LLMを設定しました")

    # --- 4. レポート生成プロンプトの定義 (コンサルタント視点でブラッシュアップ済み) ---
    analysis_prompt = f"""
あなたはグローバル企業の人事戦略を担当する**主席コンサルタント**です。
提供された**JSON形式の調査データ**（一次情報抽出結果）に基づき、クライアント（製造業企業の経営層・人事部門）が**直ちに戦略意思決定に使える**、構造的かつ洞察に満ちた週次レポートをMarkdown形式で作成してください。

単なるデータ要約ではなく、**ビジネス上の意味合い**と**競争優位性**に焦点を当てた分析を行うことがあなたのミッションです。

# 📄 入力データ (JSON)
---
{data_string}
---

# 📋 レポート出力フォーマットと分析深度
上記のJSONデータに含まれる情報を徹底的に分析し、以下の構成でレポートを作成してください。

## 📊 エグゼクティブサマリー (Executive Summary)
**最も重要かつインパクトのあるセクションです。** 経営層が5分で全体像を掴めるよう、**具体的な行動（Actionable Insights）**に繋がる洞察を含めてください。

### 🎯 今週の最重要ハイライト (Top 3 Insights)
収集データから得られる最も戦略的に重要な**3つの洞察**を、以下の形式で提示してください：

1.  **[洞察1のタイトル]**: [200-300文字で詳細を説明。単なるニュースではなく、それが示唆するトレンドや影響を含める]

2.  **[洞察2のタイトル]**: [同様に]

3.  **[洞察3のタイトル]**: [同様に]

### ⚡ 注目トレンドとそのリスク/機会
主要なトレンドについて、以下のフォーマットで分析してください：

**トレンド**: [トレンド名]
-   **機会 (Opportunity)**:
    -   **短期（6ヶ月以内）**: [具体的な機会を2-3文で]
    -   **中期（1-2年）**: [具体的な機会を2-3文で]
-   **リスク (Risk)**:
    -   **短期（6ヶ月以内）**: [具体的なリスクを2-3文で]
    -   **中期（1-2年）**: [具体的なリスクを2-3文で]

### ✅ 推奨される即時アクション
今週の動向に基づき、人事部門が**直ちに評価または開始すべき具体的な検討事項**を以下の形式で1～2点提案してください：

1.  **[アクション1のタイトル]**: [具体的な内容を3-4文で説明。対象範囲、期間、期待効果を含める]

2.  **[アクション2のタイトル]**: [同様に]

## 調査結果詳細 (Detailed Findings)
入力JSONデータに含まれる各記事について、**詳細かつ戦略的な分析レポート**を作成してください。
ただし、信頼性スコアが0.5未満の記事は記載しないでください。

**重要**: 各事例は**1,000～1,500文字程度**の詳細な分析とし、社内ナレッジベースとして十分な情報量を確保してください。

### [連番]. [記事タイトル]

#### 📋 基本情報
-   **URL**: [記事URL]
-   **情報源**: [メディア名]（[組織の特徴・信頼性の理由を1文で]）
-   **公開日**: YYYY-MM-DD
-   **地域**: [国名]
-   **カテゴリ**: [カテゴリ名]
-   **関連企業**: [企業名1], [企業名2]...
-   **製造業関連**: ✓ あり / - なし
-   **信頼性スコア**: 0.0～1.0

#### 🌐 背景とコンテキスト（200-300文字）
**業界動向**:
[この記事が発表された背景にある、業界全体のトレンドや市場環境を説明。可能であれば統計データや他の情報源への言及を含める]

**記事の位置づけ**:
[この情報源（メディア・企業）がなぜこのテーマを取り上げたのか、その戦略的意図や専門性について]

#### 📊 主要な論点と詳細分析（400-600文字）

**1. [第一の主要テーマ]**
-   **詳細**: [具体的な内容を3-5文で詳述。単なる要約ではなく、技術的側面や戦略的意義を深掘り]
-   **具体例**:
    - [可能であれば、記事内で言及されている企業事例や数値データを箇条書きで]
    - [複数の事例がある場合は2-3個列挙]
-   **統計・データ**: [記事内の数値や調査結果があれば引用]

**2. [第二の主要テーマ]**（必要に応じて）
-   **詳細**: [同様に詳述]
-   **業界への影響**: [このテーマが人事・製造業界全体にどう影響するか]

#### 🏭 製造業への示唆と適用シナリオ（300-400文字）

**短期的インパクト（6ヶ月以内）**:
-   ✅ **機会**: [この動向を活用することで得られる具体的なメリット。可能であれば定量的効果や他社事例を含める]
-   ⚠️ **リスク**: [対応しない場合の具体的なリスク。競合優位性の喪失、人材流出等]

**中期的インパクト（1-2年）**:
-   ✅ **機会**: [戦略的な活用による中長期的なメリット]
-   ⚠️ **リスク**: [市場環境の変化に伴う中長期的なリスク]

#### 🎯 推奨アクション（200-300文字）

**即時着手（Priority 1）**:
1.  **[具体的アクション1]**
    -   対象: [部門・対象範囲]
    -   期間: [目安期間]
    -   予算目安: [概算があれば]
    -   期待効果: [定性的または定量的な効果]

2.  **[具体的アクション2]**（必要に応じて）
    -   [同様に記載]

**戦略的検討（Priority 2）**:
-   [中長期的な検討事項や、人事制度・経営戦略への組み込み提案]

#### 📚 関連技術・フレームワーク
-   **[技術カテゴリ1]**: [具体的な技術名・標準名]
-   **[技術カテゴリ2]**: [同様に]
-   **[フレームワーク/手法]**: [該当する場合]

#### 🔗 補足情報
-   **関連技術タグ**: `tag1` `tag2` `tag3` `tag4` `tag5`
-   **さらなる情報源**: [関連する他の記事やベンダー情報があれば簡潔に言及]

---

## 📈 戦略的トレンド分析 (Strategic Trend Analysis)
データ全体を統合し、より高度な分析を提供します。各セクションは**300-500文字程度**で詳述してください。

### 1. 🔄 主要なテーマと進化の方向性
出現頻度の高いテーマ（例: スキルギャップのAI駆動型特定）について分析してください：

-   **現在のトレンド**: [3-4文で現状を説明]
-   **6ヶ月後の予測**: [この技術やアプローチがどう進化するか]
-   **1年後の予測**: [中長期的な進化の方向性]
-   **製造業への影響**: [このトレンドが製造業にもたらす具体的な変化]

（主要テーマが複数ある場合は、同様の形式で2-3個記載）

### 2. 🗺️ 市場の焦点と競争地図 (Competitive Landscape)
注目企業や資金調達の動きから、市場分析を行ってください：

-   **投資が集中している領域**: [例: スキルオントロジー、LXP等。各領域を2-3文で説明]
-   **主要プレイヤー分析**:
    -   **[企業カテゴリ1（例：大手HRテック）]**: [企業名と戦略を2-3文で]
    -   **[企業カテゴリ2（例：新興スタートアップ）]**: [同様に]
-   **市場予測**: [今後1-2年の市場動向予測]

### 3. 🎯 テクノロジーの成熟度評価
主要な技術について、成熟度を評価してください。以下の形式で2-4つの技術を分析：

**[技術名1]**: 🔴 黎明期 / 🟡 成長期 / 🟢 成熟期
-   **評価理由**: [3-4文で、なぜこの成熟度と判断したか。市場導入事例、標準化状況、課題等を含める]
-   **製造業への導入推奨度**: ⭐⭐⭐⭐⭐（5段階評価と理由を1-2文で）

**[技術名2]**: [同様に]

## 🏭 製造業向け行動提言 (Recommended Actions for Manufacturing)
このレポートの結論となる最も重要なセクションです。具体的かつ実行可能な提言を行ってください。

### 🎯 フォーカスすべき優先課題
製造業特有の課題に対し、収集したトレンドがどのように役立つか、**優先順位付け**して提言してください（各課題200-300文字）：

**優先度🔴 High:**
1.  **[課題1]**:
    -   **現状認識**: [課題の背景を2-3文で]
    -   **トレンドの活用方法**: [今週のデータから得られた解決策]
    -   **期待効果**: [定性的・定量的な効果]

**優先度🟡 Medium:**
2.  **[課題2]**: [同様に]

### 📋 次期検討ステップ
レポート全体を通して最も戦略的と判断した**具体的な3つのアクションアイテム**を提案してください（各300-400文字）：

1.  **[アクションアイテム1のタイトル]**:
    -   **内容**: [具体的な実施内容を3-4文で]
    -   **目的**: [このアクションの戦略的目的]
    -   **実施体制**: [推奨される担当部門や外部パートナー]
    -   **期間・予算**: [目安となる期間と予算規模]
    -   **成功指標（KPI）**: [測定可能な成果指標]

2.  **[アクションアイテム2]**: [同様に]

3.  **[アクションアイテム3]**: [同様に]

## 📚 参考情報源一覧 (Source Index)
調査に使用した全URLを以下の形式で一覧化してください：

### 信頼性スコア別分類

**⭐⭐⭐⭐⭐ 高信頼性ソース（0.8以上）**
-   [記事タイトル](URL) - [情報源名] - [公開日]

**⭐⭐⭐ 中信頼性ソース（0.6-0.7）**
-   [記事タイトル](URL) - [情報源名] - [公開日]

**📌 全ソース一覧（URL順）**
-   URL1
-   URL2
-   ...

---

**🔍 関連キーワード**: [今週のレポートで頻出したキーワードをタグ形式で列挙]

**📊 次回調査の推奨テーマ**: [今週の調査から派生する、次回深掘りすべきテーマを1-2個提案]
"""

    # --- 5. LLMの実行 ---
    today = datetime.now()
    year = target_year or today.year
    final_report = None
    
    try:
        response = model.invoke([HumanMessage(content=analysis_prompt)])
        final_report = response.content or "（内容なし）"

    except Exception as e:
        print(f"\n❌ レポート生成中にエラーが発生しました: {str(e)}")
        traceback.print_exc()
        sys.exit(1)

    # --- 6. レポートの保存 ---
    os.makedirs("reports", exist_ok=True)
    date_str = today.strftime("%Y%m%d")
    file_name = f"reports/週次レポート_{year}_{date_str}.md"

    try:
        with open(file_name, "w", encoding="utf-8") as f:
            # バッジとメタデータを含むリッチなヘッダーを作成
            header = (
                f"# 📊 週次レポート: スキルマネジメント・タレントマネジメント動向 ({year}年版)\n\n"
                f"![調査件数](https://img.shields.io/badge/調査件数-{len(raw_data)}件-blue) "
                f"![生成日](https://img.shields.io/badge/生成日-{today.strftime('%Y.%m.%d')}-green) "
                f"![分析者](https://img.shields.io/badge/分析者-主席コンサルタント-orange)\n\n"
                f"**📅 生成日時**: {today.strftime('%Y年%m月%d日 %H:%M:%S')}  \n"
                f"**📈 調査対象**: 海外HR・タレントマネジメントトレンド  \n"
                f"**🎯 対象読者**: 製造業 経営層・人事部門\n\n"
                f"---\n\n"
                f"## 📑 目次 (Table of Contents)\n\n"
                f"1. [📊 エグゼクティブサマリー](#-エグゼクティブサマリー-executive-summary)\n"
                f"2. [📋 調査結果詳細](#-調査結果詳細-detailed-findings)\n"
                f"3. [📈 戦略的トレンド分析](#-戦略的トレンド分析-strategic-trend-analysis)\n"
                f"4. [🏭 製造業向け行動提言](#-製造業向け行動提言-recommended-actions-for-manufacturing)\n"
                f"5. [📚 参考情報源一覧](#-参考情報源一覧-source-index)\n\n"
                f"---\n\n"
            )
            f.write(header + final_report)

        print("\n" + "=" * 60)
        print("✓ レポート生成完了 (コンサルタント視点)")
        print("=" * 60)
        print(f"📄 保存先: {file_name}")
        print("=" * 60 + "\n")
        
    except Exception as e:
        print(f"\n❌ Markdownファイルの保存中にエラーが発生しました: {str(e)}")
        traceback.print_exc()
        sys.exit(1)


if __name__ == "__main__":
    year_arg = None
    if len(sys.argv) > 1:
        try:
            year_arg = int(sys.argv[1])
        except ValueError:
            print("⚠️ 年指定が不正です。整数で指定してください。例: python research_analyzer.py 2026")

    generate_analysis_report(target_year=year_arg)
