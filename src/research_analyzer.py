"""
Phase 2: åˆ†æãƒ¬ãƒãƒ¼ãƒˆæ§‹é€ åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
Phase 1ã§åé›†ã•ã‚ŒãŸJSONãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã€
æ§‹é€ åŒ–ã•ã‚ŒãŸMarkdownå½¢å¼ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã€‚ï¼ˆã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆè¦–ç‚¹ï¼‰
"""
import os
import sys
import json
import traceback
from datetime import datetime

from langchain_core.messages import HumanMessage
from langchain_google_genai import ChatGoogleGenerativeAI

# JSONãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ (æ¤œç´¢ãƒ•ã‚§ãƒ¼ã‚ºã¨å…±æœ‰)
RESEARCH_DATA_PATH = "reports/research_data.json"

def generate_analysis_report(target_year: int = None):
    """åé›†ã—ãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹"""
    print("\n" + "=" * 60)
    print("ğŸ§  Phase 2: åˆ†æãƒ¬ãƒãƒ¼ãƒˆæ§‹é€ åŒ–ã‚’é–‹å§‹")
    print("=" * 60)

    # --- 1. ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª ---
    google_api_key = os.environ.get("GOOGLE_API_KEY")
    if not google_api_key:
        print("âŒ ã‚¨ãƒ©ãƒ¼: GOOGLE_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
        sys.exit(1)
    
    # --- 2. JSONãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ ---
    if not os.path.exists(RESEARCH_DATA_PATH):
        print(f"âŒ ã‚¨ãƒ©ãƒ¼: æ¤œç´¢ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {RESEARCH_DATA_PATH}")
        print("Phase 1 (research_searcher.py)ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
        sys.exit(1)

    with open(RESEARCH_DATA_PATH, "r", encoding="utf-8") as f:
        raw_data = json.load(f)

    if not raw_data:
        print("âš ï¸ è­¦å‘Š: JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã€‚")
        sys.exit(0)

    # JSONãƒ‡ãƒ¼ã‚¿ã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«çµ„ã¿è¾¼ã‚€ãŸã‚ã«æ–‡å­—åˆ—åŒ–
    data_string = json.dumps(raw_data, indent=2, ensure_ascii=False)
    
    print(f"âœ“ {len(raw_data)}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸã€‚")

    # --- 3. LLMã®æº–å‚™ ---
    model = ChatGoogleGenerativeAI(
        model="gemini-2.5-flash",
        temperature=0.1, # åˆ†æã«ã¯å°‘ã—å‰µé€ æ€§ã‚’è¨±å®¹
    )
    print("âœ“ LLMã‚’è¨­å®šã—ã¾ã—ãŸ")

    # --- 4. ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å®šç¾© (ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆè¦–ç‚¹ã§ãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—æ¸ˆã¿) ---
    analysis_prompt = f"""
ã‚ãªãŸã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¼æ¥­ã®äººäº‹æˆ¦ç•¥ã‚’æ‹…å½“ã™ã‚‹**ä¸»å¸­ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ**ã§ã™ã€‚
æä¾›ã•ã‚ŒãŸ**JSONå½¢å¼ã®èª¿æŸ»ãƒ‡ãƒ¼ã‚¿**ï¼ˆä¸€æ¬¡æƒ…å ±æŠ½å‡ºçµæœï¼‰ã«åŸºã¥ãã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆè£½é€ æ¥­ä¼æ¥­ã®çµŒå–¶å±¤ãƒ»äººäº‹éƒ¨é–€ï¼‰ãŒ**ç›´ã¡ã«æˆ¦ç•¥æ„æ€æ±ºå®šã«ä½¿ãˆã‚‹**ã€æ§‹é€ çš„ã‹ã¤æ´å¯Ÿã«æº€ã¡ãŸé€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’Markdownå½¢å¼ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚

å˜ãªã‚‹ãƒ‡ãƒ¼ã‚¿è¦ç´„ã§ã¯ãªãã€**ãƒ“ã‚¸ãƒã‚¹ä¸Šã®æ„å‘³åˆã„**ã¨**ç«¶äº‰å„ªä½æ€§**ã«ç„¦ç‚¹ã‚’å½“ã¦ãŸåˆ†æã‚’è¡Œã†ã“ã¨ãŒã‚ãªãŸã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã§ã™ã€‚

# ğŸ“„ å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ (JSON)
---
{data_string}
---

# ğŸ“‹ ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¨åˆ†ææ·±åº¦
ä¸Šè¨˜ã®JSONãƒ‡ãƒ¼ã‚¿ã«å«ã¾ã‚Œã‚‹æƒ…å ±ã‚’å¾¹åº•çš„ã«åˆ†æã—ã€ä»¥ä¸‹ã®æ§‹æˆã§ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

## ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼ (Executive Summary)
**æœ€ã‚‚é‡è¦ã‹ã¤ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã®ã‚ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚** çµŒå–¶å±¤ãŒ5åˆ†ã§å…¨ä½“åƒã‚’æ´ã‚ã‚‹ã‚ˆã†ã€**å…·ä½“çš„ãªè¡Œå‹•ï¼ˆActionable Insightsï¼‰**ã«ç¹‹ãŒã‚‹æ´å¯Ÿã‚’å«ã‚ã¦ãã ã•ã„ã€‚

-   **ä»Šé€±ã®æœ€é‡è¦ãƒã‚¤ãƒ©ã‚¤ãƒˆ (Top 3 Insights)**ï¼šåé›†ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¾—ã‚‰ã‚Œã‚‹æœ€ã‚‚æˆ¦ç•¥çš„ã«é‡è¦ãª**3ã¤ã®æ´å¯Ÿ**ï¼ˆå˜ãªã‚‹ãƒ‹ãƒ¥ãƒ¼ã‚¹ã§ã¯ãªãã€ãã‚ŒãŒç¤ºå”†ã™ã‚‹ãƒˆãƒ¬ãƒ³ãƒ‰ã‚„å½±éŸ¿ï¼‰ã‚’ç®‡æ¡æ›¸ãã§æç¤ºã€‚
-   **æ³¨ç›®ãƒˆãƒ¬ãƒ³ãƒ‰ã¨ãã®ãƒªã‚¹ã‚¯/æ©Ÿä¼š**ï¼šãƒˆãƒ¬ãƒ³ãƒ‰ãŒè‡ªç¤¾ï¼ˆè£½é€ æ¥­ï¼‰ã«ã¨ã£ã¦**çŸ­æœŸ/ä¸­æœŸçš„ã«**ã©ã®ã‚ˆã†ãªæ©Ÿä¼šï¼ˆOpportunityï¼‰ã¨ãƒªã‚¹ã‚¯ï¼ˆRiskï¼‰ã‚’ã‚‚ãŸã‚‰ã™ã‹ã‚’ç°¡æ½”ã«åˆ†æã€‚
-   **æ¨å¥¨ã•ã‚Œã‚‹å³æ™‚ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**ï¼šä»Šé€±ã®å‹•å‘ã«åŸºã¥ãã€äººäº‹éƒ¨é–€ãŒ**ç›´ã¡ã«è©•ä¾¡ã¾ãŸã¯é–‹å§‹ã™ã¹ãå…·ä½“çš„ãªæ¤œè¨äº‹é …**ï¼ˆä¾‹: ç‰¹å®šæŠ€è¡“ã®PoCé–‹å§‹ã€ç‰¹å®šãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ãƒ‡ãƒ¥ãƒ¼ãƒ‡ãƒªã‚¸ã‚§ãƒ³ã‚¹ï¼‰ã‚’1ï½2ç‚¹ææ¡ˆã€‚

## èª¿æŸ»çµæœè©³ç´° (Detailed Findings)
å…¥åŠ›JSONãƒ‡ãƒ¼ã‚¿ã«å«ã¾ã‚Œã‚‹å„è¨˜äº‹ã‚’ã€ä»¥ä¸‹ã®Markdownãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§**å¿ å®Ÿã«ã€ã‹ã¤ç°¡æ½”ã«**è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚
ãŸã ã—ã€ä¿¡é ¼æ€§ã‚¹ã‚³ã‚¢ãŒ0.5æœªæº€ã®è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ã¯è¨˜è¼‰ã—ãªã„ã§ãã ã•ã„ã€‚

### [é€£ç•ª]. [è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«]
-   **URL**: [è¨˜äº‹URL]
-   **æƒ…å ±æº**: [ãƒ¡ãƒ‡ã‚£ã‚¢å]
-   **å…¬é–‹æ—¥**: YYYY-MM-DD
-   **åœ°åŸŸ**: [å›½å]
-   **ã‚«ãƒ†ã‚´ãƒª**: [ã‚«ãƒ†ã‚´ãƒªå]
-   **é–¢é€£ä¼æ¥­**: [ä¼æ¥­å1], [ä¼æ¥­å2]...
-   **è£½é€ æ¥­é–¢é€£**: âœ“ ã‚ã‚Š / - ãªã—
-   **ä¿¡é ¼æ€§ã‚¹ã‚³ã‚¢**: 0.0ï½1.0

**æˆ¦ç•¥çš„è¦ç´„ã¨æ„ç¾©**:
[è¨˜äº‹ã®è¦ç´„ã«åŠ ãˆã€**ã€Œã“ã®å‹•ããŒæ¥­ç•Œ/ç«¶åˆã«ä¸ãˆã‚‹å½±éŸ¿ã€**ã¨ã„ã†è¦³ç‚¹ã‚’åŠ å‘³ã—ãŸ3ï½5æ–‡ã®æ—¥æœ¬èªè¦ç´„]

**é‡è¦ãƒã‚¤ãƒ³ãƒˆ (Key Strategic Takeaways)**:
-   [ãƒã‚¤ãƒ³ãƒˆ1: æŠ€è¡“çš„/æ©Ÿèƒ½çš„ãªå´é¢]
-   [ãƒã‚¤ãƒ³ãƒˆ2: ç«¶åˆ/å¸‚å ´ã¸ã®å½±éŸ¿]
-   [ãƒã‚¤ãƒ³ãƒˆ3: é©ç”¨å¯èƒ½æ€§/æ¤œè¨äº‹é …]

**é–¢é€£æŠ€è¡“ã‚¿ã‚°**: `tag1` `tag2` `tag3`

**è£½é€ æ¥­ã¨ã®é–¢é€£æ€§**: [ã‚ã‚‹å ´åˆã®ç†ç”±ã‚’ã€è£½é€ ç¾å ´ã‚„ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³ã®æ–‡è„ˆã§è¨˜è¼‰]

---

## æˆ¦ç•¥çš„ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ (Strategic Trend Analysis)
ãƒ‡ãƒ¼ã‚¿å…¨ä½“ã‚’çµ±åˆã—ã€ã‚ˆã‚Šé«˜åº¦ãªåˆ†æã‚’æä¾›ã—ã¾ã™ã€‚

1.  **ä¸»è¦ãªãƒ†ãƒ¼ãƒã¨é€²åŒ–ã®æ–¹å‘æ€§**: å‡ºç¾é »åº¦ã®é«˜ã„ãƒ†ãƒ¼ãƒï¼ˆä¾‹: ã‚¹ã‚­ãƒ«ã‚®ãƒ£ãƒƒãƒ—ã®AIé§†å‹•å‹ç‰¹å®šï¼‰ã«ã¤ã„ã¦ã€**ãã®æŠ€è¡“ã‚„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒä»Šå¾Œ1å¹´ã§ã©ã®ã‚ˆã†ã«é€²åŒ–ã™ã‚‹ã‹**ã‚’äºˆæ¸¬ã€‚
2.  **å¸‚å ´ã®ç„¦ç‚¹ã¨ç«¶äº‰åœ°å›³ (Competitive Landscape)**: æ³¨ç›®ä¼æ¥­ã‚„è³‡é‡‘èª¿é”ã®å‹•ãã‹ã‚‰ã€**ã©ã®é ˜åŸŸï¼ˆä¾‹: ã‚¹ã‚­ãƒ«ã‚ªãƒ³ãƒˆãƒ­ã‚¸ãƒ¼ã€LXPï¼‰ã«è³‡æœ¬ã‚„ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãŒé›†ä¸­ã—ã¦ã„ã‚‹ã‹**ã‚’ç‰¹å®šã€‚
3.  **ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã®æˆç†Ÿåº¦è©•ä¾¡**: ä¸»è¦ãªæŠ€è¡“ã‚¿ã‚°ï¼ˆä¾‹: Skills Graph, xAPI, AIï¼‰ã«ã¤ã„ã¦ã€ãã‚Œãã‚Œ**ã€Œé»æ˜æœŸ/æˆé•·æœŸ/æˆç†ŸæœŸã€**ã®ã„ãšã‚Œã‹ã‚’è©•ä¾¡ã—ã€ãã®ç†ç”±ã‚’ç°¡æ½”ã«èª¬æ˜ã€‚

## è£½é€ æ¥­å‘ã‘è¡Œå‹•æè¨€ (Recommended Actions for Manufacturing)
ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã®çµè«–ã¨ãªã‚‹æœ€ã‚‚é‡è¦ãªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚

-   **ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã™ã¹ãå„ªå…ˆèª²é¡Œ**: è£½é€ æ¥­ç‰¹æœ‰ã®èª²é¡Œï¼ˆä¾‹: æŠ€èƒ½ä¼æ‰¿ã€å¤šèƒ½å·¥è‚²æˆã€OJTãƒ‡ã‚¸ã‚¿ãƒ«åŒ–ï¼‰ã«å¯¾ã—ã€åé›†ã—ãŸãƒˆãƒ¬ãƒ³ãƒ‰ãŒã©ã®ã‚ˆã†ã«å½¹ç«‹ã¤ã‹ã€**å„ªå…ˆé †ä½ä»˜ã‘**ã—ã¦æè¨€ã€‚
-   **æ¬¡æœŸæ¤œè¨ã‚¹ãƒ†ãƒƒãƒ—**: ãƒ¬ãƒãƒ¼ãƒˆå…¨ä½“ã‚’é€šã—ã¦æœ€ã‚‚æˆ¦ç•¥çš„ã¨åˆ¤æ–­ã—ãŸ**å…·ä½“çš„ãª3ã¤ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ **ï¼ˆä¾‹: AIã‚¹ã‚­ãƒ«ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ™ãƒ³ãƒ€ãƒ¼ã®RFIç™ºè¡Œã€ãƒ‡ã‚¸ã‚¿ãƒ«ãƒãƒƒã‚¸å°å…¥ã®äº‹æ¥­æ€§è©•ä¾¡ï¼‰ã‚’ææ¡ˆã€‚

## å‚è€ƒæƒ…å ±æºä¸€è¦§ (Source Index)
èª¿æŸ»ã«ä½¿ç”¨ã—ãŸå…¨URLã‚’ç®‡æ¡æ›¸ãã§ä¸€è¦§åŒ–ã—ã¦ãã ã•ã„ã€‚
"""

    # --- 5. LLMã®å®Ÿè¡Œ ---
    today = datetime.now()
    year = target_year or today.year
    final_report = None
    
    try:
        response = model.invoke([HumanMessage(content=analysis_prompt)])
        final_report = response.content or "ï¼ˆå†…å®¹ãªã—ï¼‰"

    except Exception as e:
        print(f"\nâŒ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
        traceback.print_exc()
        sys.exit(1)

    # --- 6. ãƒ¬ãƒãƒ¼ãƒˆã®ä¿å­˜ ---
    os.makedirs("reports", exist_ok=True)
    date_str = today.strftime("%Y%m%d")
    file_name = f"reports/é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ_{year}_{date_str}.md"

    try:
        with open(file_name, "w", encoding="utf-8") as f:
            header = (
                f"# é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ: ã‚¹ã‚­ãƒ«ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆãƒ»ã‚¿ãƒ¬ãƒ³ãƒˆãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆå‹•å‘ ({year}å¹´ç‰ˆ)\n"
                f"**ä¸»å¸­ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆã«ã‚ˆã‚‹åˆ†æ**\n"
                f"**èª¿æŸ»å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ä»¶æ•°**: {len(raw_data)}ä»¶\n"
                f"**ç”Ÿæˆæ—¥æ™‚**: {today.strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')}\n\n---\n\n"
            )
            f.write(header + final_report)

        print("\n" + "=" * 60)
        print("âœ“ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº† (ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆè¦–ç‚¹)")
        print("=" * 60)
        print(f"ğŸ“„ ä¿å­˜å…ˆ: {file_name}")
        print("=" * 60 + "\n")
        
    except Exception as e:
        print(f"\nâŒ Markdownãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
        traceback.print_exc()
        sys.exit(1)


if __name__ == "__main__":
    year_arg = None
    if len(sys.argv) > 1:
        try:
            year_arg = int(sys.argv[1])
        except ValueError:
            print("âš ï¸ å¹´æŒ‡å®šãŒä¸æ­£ã§ã™ã€‚æ•´æ•°ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚ä¾‹: python research_analyzer.py 2026")

    generate_analysis_report(target_year=year_arg)
